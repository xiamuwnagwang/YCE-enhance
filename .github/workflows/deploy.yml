name: Deploy to Production Server

on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'shared/**'
      - 'docker-compose.yml'
      - 'deploy.sh'
      - '.env.example'
  workflow_dispatch:
    inputs:
      skip_build_cache:
        description: 'è·³è¿‡ Docker æ„å»ºç¼“å­˜ (å®Œå…¨é‡å»º)'
        required: false
        default: 'false'
        type: boolean

env:
  DEPLOY_PATH: /opt/youwen

jobs:
  deploy:
    name: ğŸš€ Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          SKIP_CACHE: ${{ github.event.inputs.skip_build_cache || 'false' }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: DEPLOY_PATH,SKIP_CACHE
          command_timeout: 25m
          script: |
            set -e

            echo "========================================="
            echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½² youwen"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "========================================="

            # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "ğŸ“ é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†ä»“åº“..."
              git clone https://github.com/${{ github.repository }}.git "$DEPLOY_PATH"
            fi

            cd "$DEPLOY_PATH"

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            git clean -fd

            # ç¡®ä¿ .env å­˜åœ¨
            if [ ! -f .env ]; then
              echo "âš ï¸ .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨æœåŠ¡å™¨ä¸Šé…ç½® $DEPLOY_PATH/.env"
              echo "å‚è€ƒ .env.example åˆ›å»º"
              exit 1
            fi

            # æ‰§è¡Œéƒ¨ç½²
            echo "ğŸ”¨ æ„å»ºå¹¶å¯åŠ¨å®¹å™¨..."
            chmod +x deploy.sh

            # åŒæ­¥å†…ç½® skillsï¼ˆéå¼ºä¾èµ–ï¼‰
            if command -v node >/dev/null 2>&1; then
              if [ -f backend/scripts/vendor_skills.mjs ]; then
                node backend/scripts/vendor_skills.mjs || echo "âš ï¸ skills åŒæ­¥å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²ï¼ˆè‹¥å·²æäº¤ backend/skills å¯å¿½ç•¥ï¼‰"
              else
                echo "âš ï¸ æœªæ‰¾åˆ° backend/scripts/vendor_skills.mjsï¼Œè·³è¿‡ skills åŒæ­¥"
              fi
            else
              echo "âš ï¸ æœªæ‰¾åˆ° nodeï¼Œè·³è¿‡ skills åŒæ­¥"
            fi
            
            if [ "$SKIP_CACHE" = "true" ]; then
              echo "ğŸ§¹ è·³è¿‡ç¼“å­˜ï¼Œå®Œå…¨é‡å»º..."
              docker compose down
              docker compose build --no-cache
              docker compose up -d
            else
              ./deploy.sh
            fi

            echo ""
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆ: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "========================================="

      - name: Health Check
        if: success()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 2m
          script: |
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10

            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            docker compose -f /opt/youwen/docker-compose.yml ps

            # å¥åº·æ£€æŸ¥
            FRONTEND_OK=false
            BACKEND_OK=false

            for i in $(seq 1 15); do
              if ! $FRONTEND_OK && curl -sf -o /dev/null http://localhost:18080; then
                echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
                FRONTEND_OK=true
              fi
              if ! $BACKEND_OK && curl -sf -o /dev/null http://localhost:13005/api/health 2>/dev/null || curl -sf -o /dev/null http://localhost:13005; then
                echo "âœ… åç«¯æœåŠ¡æ­£å¸¸"
                BACKEND_OK=true
              fi
              if $FRONTEND_OK && $BACKEND_OK; then
                break
              fi
              echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/15)"
              sleep 3
            done

            if ! $FRONTEND_OK; then
              echo "âš ï¸ å‰ç«¯æœåŠ¡æœªå°±ç»ª"
              docker compose -f /opt/youwen/docker-compose.yml logs frontend --tail=30
            fi
            if ! $BACKEND_OK; then
              echo "âš ï¸ åç«¯æœåŠ¡æœªå°±ç»ª"
              docker compose -f /opt/youwen/docker-compose.yml logs backend --tail=30
            fi

      - name: Notify on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 1m
          script: |
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¾“å‡ºå®¹å™¨æ—¥å¿—..."
            docker compose -f /opt/youwen/docker-compose.yml logs --tail=50
